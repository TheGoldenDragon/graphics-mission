<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>PoolTable Simulation</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
<script src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/Detector.js"></script>
<script src="js/MathFunctions.js"></script>
<script src="js/InitializeScene.js"></script>
<script src="js/GameControls.js"></script>

<div class="scoreboard">
	<h2>Scoreboard (statistieken)</h2>
	<div class="inner">
    	<div class="scores">
            Aantal punten:<br>
            <p id="points">0</p>
        Aantal keren geschoten:<br>
        <p id="shotsfired">0</p>
        Aantal geraakte ballen met de witte bal:<br>
        <p id="ballshit"> 0</p>
        
        Aantal connecties tussen ballen:<br>
         <p id="connect"> 0</p>
         
          Extra informatie (debug):<br>
         <p id="debug"></p>
        </div>
    </div>
</div>
<div class="main">
    <div class="logo"></div>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="overlay" style="background-color:#128000; width: 100px; height: 50px; padding-left:12px; margin:10px;">
            <p id="shotspeed">0</p>
            <p id="points"></p>
        </div>
    </div>
</div>

<script>
    if (!Detector.webgl) Detector.addGetWebGLMessage();

    var camera, controls, scene, renderer, whiteball, clock, cue;
    var shotsFired = 0;
    var ballConnect = 0;
    var pointsScored = 0;
    var ballsHit = 0;
    var mouse = new THREE.Vector2();
    var frameDeltaTime;

    var shotspeed = 0;
    var balls = [];

    document.addEventListener('mousemove', onDocumentMouseMove, true);
    document.addEventListener('keydown', onKeyDown, true);
    document.addEventListener('keyup', onKeyUp, true);

    init(); //create objects e.g.
    render();

    function updateScoreboard() {
        document.getElementById("shotspeed").innerHTML = "HitPower: " + shotspeed;
        document.getElementById("points").innerHTML = pointsScored;
        document.getElementById("shotsfired").innerHTML = shotsFired;
        document.getElementById("ballshit").innerHTML = ballsHit;
        document.getElementById("connect").innerHTML = ballConnect;

    }

    function render() {
        frameDeltaTime = clock.getDelta();
        controls.update();

        setCamera();
        if (ballsRoll()) {
            calcPhysics(frameDeltaTime);
        }
        updateScoreboard();
        renderer.render(scene, camera);
        requestAnimationFrame(render);
    }

    function calcPhysics(clockDeltaTime) {
        //for each ball
        for (i = 0; i < balls.length; i++) {
            //for each other ball
            if (balls[i].ball.speed <= 0)
                continue;

            var ballSender = balls[i];

            for (x = 0; x < balls.length; x++) {
                if (balls[i].name == balls[x].name)
                    continue;

                var ballReceiver = balls[x];

                var differenceVector = GetDistanceVector(ballSender.ball.position, ballReceiver.ball.position);
                var distance = Math.sqrt(differenceVector.x * differenceVector.x + differenceVector.y * differenceVector.y + differenceVector.z * differenceVector.z);

                if (distance < 1 + 1) {
                    ballConnect += 1;
                    var vectorNormal = GetVectorNormal(differenceVector, distance);
                    var vectorVelocityDelta = GetObjectVelocityDelta(ballSender, ballReceiver);
                    var dotProduct = GetDotProduct(vectorVelocityDelta, vectorNormal);
                    if (dotProduct > 0) {
                        var coefficient = 0.5;
                        var impulseStrength = (1 + coefficient) * dotProduct;
                        var impulseVector = GetImpulseVector(impulseStrength, vectorNormal);

                        ballSender.direction = updateDirection(ballSender.direction, impulseVector, true);
                        ballReceiver.direction = updateDirection(ballReceiver.direction, impulseVector, false);

                        //var iBallSpeed = balls[i].ball.speed;
                        //var xBallSpeed = balls[x].ball.speed;
                        ballReceiver.ball.speed = ballSender.ball.speed;
                        ballSender.ball.speed = ballSender.ball.speed / 2;
                    }
                }
            }
        }

        //Update ball positions and speed
        for (i = 0; i < balls.length; i++) {
            if (balls[i].ball.speed > 0) {
                balls[i].ball.position = calculatePos(balls[i], clockDeltaTime);
                balls[i].ball.speed = calculateSpeed(balls[i].ball.speed);
                outOfBounds(balls[i]);
            }
        }
    }

    function calculateSpeed(speed) {
        if (speed > 0) {
            return speed -= 0.1;
        }
        else { return 0; }
    }

    function outOfBounds(ball) {
        if (ball.ball.position.z > 40.6) { //down : push up
            ball.direction.z = -1; //up
            ball.ball.position.z = 40.6
            ball.ball.speed *= 0.75;
        }
        if (ball.ball.position.z < -41.1) { //up : push down
            ball.direction.z = 1; //left
            ball.ball.position.z = -41.1
            ball.ball.speed *= 0.75;
        }
        if (ball.ball.position.x > 22) { //right : push left
            ball.direction.x = -1; //down
            ball.ball.position.x = 22
            ball.ball.speed *= 0.75;
        }
        if (ball.ball.position.x < -22) { //left : push right
            ball.direction.x = 1; //right
            ball.ball.position.x = -22
            ball.ball.speed *= 0.75;
        }
    }

    function shootBall() {
        if (!ballsRoll()) {
            whiteball.ball.speed = shotspeed;
            whiteball.direction = camera.getWorldDirection();
            shotsFired += 1;
            shotspeed = 0;
        }
    }

    function ballsRoll() {
        for (i = 0; i < balls.length; i++) {
            if (balls[i].ball.speed > 0) {
                return true;
            }
        }
        return false;
    }

    function setCamera() {
        if (ballsRoll()) {
            cue.position.z = 100;
            controls.target = new THREE.Vector3(0,13,0);
        }
        else {
            cue.position.z = 0.1;
            controls.target = whiteball.ball.position;
        }
    }
	</script>
    
</body>
</html>
